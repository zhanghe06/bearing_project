# 消息队列（Message Queue）

## 异步阻塞模型

新建资源 - 生产任务（数据库与任务队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | 创建记录，设置状态：准备中 | -
2 | - | 发送消息
3 | 更新状态：创建中 | 发送成功
4 | 更新状态：已失败 | 发送失败


新建资源 - 消费任务（数据库与任务队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | - | 订阅任务
2 | - | 获取任务
3 | - | 消费任务（阻塞）
4 | 更新状态：已完成 | 消费完成
5 | - | 确认（成功/失败）

- 消费过程中，异常断电，消息如何处理的？  
    + 3-4步断电：重启任务，非幂等操作可能有副作用
    + 4-5步断电：消费前检查数据任务状态，已完成，则忽略
- 重新启动之后，消息是否自动重新入队？  
设置持久化之后，重回队列


新建资源 - 任务结果（数据库与结果队列的顺序策略）

序号 | 数据处理 | 消息处理
:---: | --- | ---
1 | - | 订阅结果
2 | - | 消费结果（阻塞）
3 | 更新状态：已完成 | 消费完成
4 | 更新状态：已超时 | 消费超时


## 消息幂等

## 并发场景支持消息幂等
